{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
{% endblock %}

{% block body %}
<h1><a href="{{url_for('.upload')}}">Upload Images and Videos</a></h1>
<div class="uploads">
	{% raw %}
	<div class="upload mb-5 pb-3" v-for="upload in uploads">
		<h3 class="upload-title">{{upload.title}}</h3>
		<h4 class="uploaded-by">Uploaded By: {{upload.user.first_name}} {{upload.user.last_name}}</h4>
		{% endraw %}
		{% if current_user.is_admin %}
		<h5 class="text-danger" @click="deleteUpload(upload.uuid)"> Delete</h5>
		{% endif %}
		{% raw %}

		<div class="files row justify-content-around">
			<div class="grid-sizer"></div>
			<template v-for="file in upload.files">
				<div class="grid-item " v-if="file.media_type == 'image'">
					<a :href="s3(file.s3_key)" :data-fancybox="upload.uuid">
						<img :src="s3(file.s3_key)">
					</a>
				</div>
				<div class="grid-item" v-if="file.media_type == 'video'">
					<a :href="cfGif(file.cf_data.result.uid)" v-if="!file.cf_data.result.readyToStream" :data-fancybox="upload.uuid">
						<img :src="cfGif(file.cf_data.result.uid)">
						<div class="encoding">Encoding... {{percent(file.cf_data.result.status.pctComplete)}}</div>
					</a>
					<a :href="cfEmbed(file.cf_data.result.uid)" v-if="file.cf_data.result.readyToStream" :data-fancybox="upload.uuid" data-type="iframe">
						<img :src="cfGif(file.cf_data.result.uid)">
					</a>
				</div>
			</template>
			
		</div>
	</div>
	{% endraw %}


	
</div>

{% endblock %}

{% block scripts %}
<!-- <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script> -->
<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

<script type="text/javascript">
	var app = new Vue({
			el: '.uploads',
			data: {
				uploads: []
			},
			methods: {
				s3: function(key){
					return "{{S3_PUBLIC_PATH}}"+key;
				},
				cfGif: function(uid){
					return "https://videodelivery.net/" + uid + "/thumbnails/thumbnail.gif";
				},
				cfEmbed: function(uid){
					return "https://watch.cloudflarestream.com/" + uid;
				},
				percent: function(percent){
					return parseFloat(percent).toFixed(0) + '%';
				},
				getData: function(){
					var self = this;
					jQuery.ajax({
						url: '/api/uploads',
						dataType: 'json'
					}).done(function(data){
						self.uploads = data.uploads;
						self.reflow();
					});
				},
				reflow: function(){
					jQuery('.files').each(function(){
						jQuery(this).masonry({
							itemSelector: '.grid-item'
						})
					});
				},
				deleteUpload: function(uuid){
					if (confirm('are you sure?')){
						var self = this;
						jQuery.ajax({
							url: '/api/upload/'+uuid,
							type: 'DELETE',
							dataType: 'json'
						}).done(function(data){
							console.log(data);
							self.getData();
						})
					}
				}
			},
			created: function(){
				var self = this;
				setInterval(function(){
					self.getData();
				}, 5000);
				self.getData();
			},
		});

</script>
{% endblock %}